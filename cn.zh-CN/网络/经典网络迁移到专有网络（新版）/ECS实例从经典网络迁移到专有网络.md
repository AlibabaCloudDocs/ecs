---
keyword: [变更网络类型, 过保迁移, 经典网络]
---

# ECS实例从经典网络迁移到专有网络

您可以将一台或多台ECS实例从经典网络迁移到专有网络VPC。变更网络类型后，专有网络VPC类型ECS实例能使用更丰富的功能，例如绑定弹性公网IP（EIP）等。

迁移到专有网络VPC前，原经典网络类型ECS实例必须满足以下条件：

-   不能挂载本地盘。更多信息，请[提交工单](https://selfservice.console.aliyun.com/ticket/createIndex)咨询。
-   公网带宽不为0 Mbps。如果需要迁移，请先升级公网带宽。具体操作，请参见[修改公网带宽](/cn.zh-CN/实例/升降配实例/升降配方式概述.mdChangeBandwidth)。
-   部分华东1（杭州）地域可用区C的ECS实例不支持迁移。

## 迁移影响

迁移影响信息如下表所示。

|影响项目|说明|
|----|--|
|迁移时长|15分钟左右。|
|实例重启|网络迁移开始时会重启ECS实例，建议您预约一个业务低峰期进行迁移。|
|网络变化|从经典网络（Classic）迁移至专有网络VPC。 专有网络具体信息，请参见[什么是专有网络](/cn.zh-CN/产品简介/什么是专有网络.md)。|
|软件授权码变化|迁移后，软件授权码可能会发生变化。|
|IP地址|-   公网IP地址不变。

**说明：** 专有网络VPC类型公网IP地址通过NAT方式映射，您在ECS实例内只能查看到私网IP地址。如果您的应用依赖于操作系统上可见的公网IP地址，请谨慎评估。

-   内网IP地址
    -   设置**保留实例内网IP**为**是**，保持不变。
    -   设置**保留实例内网IP**为**否**，ECS实例私有IP地址会从目标虚拟交换机网段中随机分配。迁移完成后，您也可以自行修改内网IP。具体操作，请参见[修改私有IP地址](/cn.zh-CN/网络/修改IPv4地址/修改私有IP地址.md)。 |
|磁盘识别名称|部分ECS实例同时会升级底层虚拟化技术，您的ECS磁盘识别名称会发生变化。在Linux实例中，磁盘会被识别为vda、vdb和vdc等。-   如果您的实例在迁移前，磁盘识别名称已经是vda、vdb等，则无影响。
-   如果您的实例在迁移前，磁盘识别名称是xvda、xvdb等，迁移后会被识别为vda、vdb等。阿里云会为Linux实例自动修复/etc/fstab文件，但您仍需关注其他应用是否对磁盘识别名称有依赖。 |
|I/O性能|迁移后，由于还需要在底层追加数据，所以I/O性能会短暂下降，同时暂时关闭快照和磁盘功能。通常情况下，追加100 GiB的数据需要4小时左右。|
|费用估算|不需要额外计费。包年包月ECS实例从新的计费周期开始，实例规格的单价会变化，同类配置条件下，专有网络VPC类型的费用账单相对较低。|
|其他|-   实例ID、用户名和登录密码不变。
-   将取消未生效或未支付的续费变配订单，您可以重新操作续费变配。
-   负载均衡SLB的虚拟服务器组（VServerGroup）中如果添加了该ECS实例，迁移后ECS实例不会自动挂载到SLB。关于如何重新添加虚拟服务器组，请参见[编辑虚拟服务器组](/cn.zh-CN/传统型负载均衡CLB/CLB用户指南/后端服务器/虚拟服务器组/编辑虚拟服务器组.md)。 |

## 迁移准备工作

1.  为磁盘创建快照并备份数据。具体操作，请参见[创建一个云盘快照](/cn.zh-CN/快照/使用快照/创建一个云盘快照.md)。
2.  （可选）如果您的ECS实例与云数据库建立了业务关联，您需要提前将云数据库设置为混访模式。混访模式下，同时支持经典网络和专有网络类型ECS实例访问云数据库。更多信息，请参见[云数据库混访概述](/cn.zh-CN/最佳实践/经典网络迁移到VPC/云数据库混访/云数据库混访概述.md)。
3.  （可选）如果您的ECS实例与云数据库等其他有白名单功能的服务建立了业务关联，如RDS，您需要提前将虚拟交换机的网段加入云数据库白名单。具体操作，请参见[设置白名单]()。
4.  （可选）建议您将应用服务设置为开机自启动，并做好可用性监控。
5.  关闭或卸载云服务器安全软件。

    **说明：** 此次迁移会更新ECS实例设备驱动，您需要暂时关闭或卸载ECS实例上安装的服务器安全软件。例如，安全狗、护士神和云锁等。

6.  预留500 MiB以上系统盘空间。
7.  目标专有网络VPC的虚拟交换机中必须有充足的私网IP地址，地址数量必须大于待迁移的实例数量。

## 步骤一：创建迁移计划

1.  登录[ECS管理控制台](https://ecs.console.aliyun.com)。

2.  在左侧导航栏，单击**运维与监控** \> **实例迁移计划**。

3.  在顶部菜单栏左上角处，选择地域。

4.  单击**创建迁移计划**。

5.  在**配置迁移计划**引导页，配置目标网络等信息，单击**下一步**。

    1.  设置目标可用区与专有网络。

        ![设置网络](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3023728061/p203053.png)

        |配置项|说明|
        |---|--|
        |**请输入计划名称**|自定义迁移计划名称。|
        |**选择目标可用区**|从下拉列表中选择需要迁移的目标可用区。可用区选项是系统根据资源自动规划，如您的业务需要指定具体可用区，请[提交工单](https://selfservice.console.aliyun.com/ticket/createIndex)咨询。

**说明：** 一个实例迁移计划只能设置一个可用区，如果您需要设置多个可用区，需要创建多个迁移计划。 |
        |**选择迁移的目标专有网络**|从下拉列表中选择需要迁移的目标专有网络。        -   选择**（默认）系统自动创建专有网络，网段：10.0.0.0/8**：适合未创建过10.0.0.0/8网段VPC，同时需要保留ECS实例内网IP的场景。

选择此选项，系统自动为您创建10.0.0.0/8的VPC。

        -   选择10.0.0.0/8网段的VPC：适合已创建10.0.0.0/8网段VPC，需要保留ECS实例内网IP的场景。
        -   选择非10.0.0.0/8网段的VPC：适合已有VPC网络规划，不需要保留ECS实例内网IP的场景。 |

    2.  设置实例网络属性。

        ![网络属性](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4023728061/p203058.png)

        |配置项|说明|
        |---|--|
        |**目标安全组**|选择迁移后实例的安全组。        -   （默认）克隆经典实例安全组：克隆原来经典网络的安全组，安全组规则和原安全组保持一致。

如果您在**选择迁移的目标专有网络**中选择**（默认）系统自动创建专有网络，网段：10.0.0.0/8**，则自动克隆原安全组，您无法修改。

**说明：** 不支持克隆存在组组授权规则的安全组。

        -   指定安全组：从下拉列表中选择已有安全组。

**说明：** 安全组设置不当，会影响您的网络访问，请确保安全组规则的正确性。 |
        |**优先保留Mac地址策略**|选择需要保留的MAC地址，可选**私网Mac**或**公网Mac**。经典网络中，实例如果有公网IP，则同时拥有公网MAC地址和私有MAC地址；专有网络中，实例只有私网MAC地址，公网IP是通过NAT方式映射实现。

        -   如果您的业务系统绑定了MAC地址（例如业务系统中配置了MAC地址，部分软件采用绑定网卡MAC地址注册等），请选择关联的MAC地址保留。
        -   如果您的业务系统没有绑定MAC地址，则可以选择任一项保留。 |

    3.  设置实例网络连通性。

        ![实例连通](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4023728061/p203061.png)

        |配置项|说明|
        |---|--|
        |**保留实例内网IP**|设置是否保留ECS实例原来的内网IP地址，并创建或选择虚拟交换机。        -   选择**是**，保留ECS实例原来的内网IP地址，并设置**创建虚拟交换机策略**。

            -   **创建虚拟交换机策略**选择**自动**：系统自动创建虚拟交换机。
            -   **创建虚拟交换机策略**选择**手动**：您需要在迁移的目标可用区，根据迁移计划内所有经典实例的内网IP规划，创建好交换机。
**说明：** 如果您在**选择迁移的目标专有网络**中选择**（默认）系统自动创建专有网络，网段：10.0.0.0/8**，系统自动保留实例内网IP并自动创建虚拟交换机策略，您无法修改。

        -   选择**否**，不保留ECS实例原来的内网IP地址，同时需要从下拉列表中选择虚拟交换机。

**说明：** 如果您已创建虚拟交换机，但下拉列表中找不到，表示您迁移后的实例和虚拟交换机不在同一个可用区，您需要在目标可用区重新创建虚拟交换机。具体操作，请参见[使用交换机](/cn.zh-CN/专有网络和交换机/使用交换机.md)。 |
        |**已迁移实例和该计划内还未迁移的经典实例保持内网联通**|迁移到VPC的ECS实例是否需要和原经典网络中其他ECS实例保持内网互通，可选**是**或者**否**。如果您选择**是**，请根据不同方案进行差异设置：

        -   如果您选择保留内网IP的迁移方案，需要在下一步的**选择待迁移实例**中添加所有需要内网联通的经典网络实例（包括需要迁移到VPC和保留在经典网络的ECS实例）。不在迁移计划中的经典网络实例将无法和VPC中实例内网互通。一旦配置完成，将不能删除或增加。
        -   如果您选择改变内网IP的迁移方案，请提前配置好经典网络实例的ClassicLink链接实现与专有网络的联通。具体操作，请参见[经典网络和专有网络互通](/cn.zh-CN/网络/经典网络和专有网络互通.md)。 |

6.  在**选择待迁移实例**引导页，选中待迁移的ECS实例，单击**下一步**。

    如果您选择保留实例内网IP，同时迁移后的ECS实例需要和原经典网络中的实例互通，则添加所有需要内网联通的经典网络实例（包括需要迁移到VPC的实例和保留在经典网络的ECS实例）。

    **说明：** 不在迁移计划中的经典网络实例将无法和VPC中实例内网互通。一旦配置完成，将不能删除或增加。

    ![选择实例](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2835728061/p203137.png)

    -   ① 需要迁移到VPC的实例
    -   ② 保留在经典网络的实例
7.  在**预约迁移**引导页，为实例设置迁移时间，单击**创建验证**。

    在迁移时需要重启ECS实例，建议您设置业务低谷的时间段进行迁移。支持单个、批量或全量设置ECS实例的迁移时间：

    -   设置单个实例的迁移时间：在实例的**操作**列，单击**预约迁移时间**进行配置。
    -   批量设置实例的迁移时间：在实例列表选中多个实例，单击**批量预约迁移时间**进行配置。
    -   全量设置ECS实例统一的迁移时间：单击**设置统一迁移时间**进行配置。
    **说明：** 需要保持互通的经典网络实例，请设置较晚的迁移时间。在迁移时间到期前，请评估是否进行迁移。

8.  在**创建验证**对话框中，您可以查看迁移注意事项并验证是否符合要求。

    -   如果您的迁移计划符合要求，选中迁移提示信息，并单击**确认并创建**。
    -   如果您的迁移计划不符合要求，系统将提示错误信息。此时您可以根据错误信息修改问题后重新创建迁移计划。

## 步骤二：正式迁移

迁移计划创建完成后，系统将在指定时间自动为您迁移ECS实例。

![迁移完成](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7539018061/p201632.png)

**说明：** 部分实例迁移过程中会进行磁盘迁移。如果您的ECS实例需要进行物理机升级或跨可用区迁移，ECS实例重启后，还需要在底层追加数据，所以I/O性能会短暂下降，同时暂时关闭快照和磁盘功能。通常情况下，追加100 GiB的数据需要4小时左右。

## 步骤三：检查迁移结果

1.  在左侧导航栏，选择**实例与镜像** \> **实例**。

2.  找到已迁移的实例，单击实例ID。

3.  在**实例详情**页面，查看实例的网络类型是否为**专有网络**。

    ![查看结果](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3464718061/p201827.png)

4.  检查内网环境和业务运行环境。

    |场景|迁移计划|后续操作|
    |--|----|----|
    |经典网络实例全部迁移到VPC|**选择迁移的目标专有网络**中选择**（默认）系统自动创建专有网络，网段：10.0.0.0/8**。|检查您的业务系统是否正常运行。|
    |部分ECS迁移到VPC；部分ECS还在经典网络|    -   **选择迁移的目标专有网络**选择**（默认）系统自动创建专有网络，网段：10.0.0.0/8**。
    -   **已迁移实例和该计划内还未迁移的经典实例保持内网联通**选择**是**。
|检查您的业务系统是否正常运行。|
    |其他场景|**选择迁移的目标专有网络**选择非10.0.0.0/8网段的VPC。|    1.  根据需要检查网络连通性。
    2.  如果业务中通过内网IP对接，需要配置新的内网IP。
    3.  检查您的业务系统是否正常运行。 |


## 迁移后

1.  如果您使用的是Linux系统，并且迁移后私有IP已变动，需要修改ECS实例的/etc/hosts文件。

    ![修改hosts](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7421652951/p109912.png)

    1.  执行命令`vi /etc/hosts`，输入i。
    2.  将原私有IP修改为迁移后的私有IP。
    3.  按Esc，输入:wq，按回车键（Enter）。
2.  在其他云产品白名单中移除废弃的内网IP地址，例如，[RDS](/cn.zh-CN/云数据库 RDS 简介/什么是云数据库RDS.md)、[SLB](/cn.zh-CN/传统型负载均衡CLB/CLB产品简介/什么是负载均衡.md)、[OSS](/cn.zh-CN/产品简介/什么是对象存储OSS.md)或者[容器服务](/cn.zh-CN/产品简介/什么是容器服务.md)等。
3.  ECS实例的可用区可能会发生变化。受影响的关联服务有云数据库RDS、Redis或者MongoDB，请及时调整您的应用配置，确保您的业务能够持续提供服务。具体操作，请参见[迁移可用区](/cn.zh-CN/RDS MySQL 数据库/变更实例/迁移可用区.md)。
4.  如果您长时间未重启或升级过内核，本次重启后可能会有文件系统检查（File System Check，即fsck）、相关配置改动失效、启动失败等问题。
5.  （可选）处理因网卡被删除发生的授权码变化：若ECS实例上的软件绑定了网卡MAC地址，如果软件供应商认可阿里云的迁移证明，您可以重新授权；若存在问题，您需要根据实际情况订正或者选择回滚。
6.  （可选）如果您的ECS实例长时间未重启，或者升级内核后未重启过，在重启时，系统会检查文件系统和更新相关配置。如若发生重启失败等问题，请及时[提交工单](https://selfservice.console.aliyun.com/ticket/createIndex.htm)联系阿里云。

## 常见问题

**Q：迁移后无法打开网站、服务不可用或者无法读写数据库**

可能是新安全组没有开启相应通信端口。您可以尝试[克隆原有的安全组规则](/cn.zh-CN/安全/安全组/管理安全组/克隆安全组.md)。

**Q：迁移后无法正常使用软件，提示授权码过期、授权码无效或者没有授权码等**

此时有两种可能原因：

-   该应用没有迁移许可计划。此时，您可以联系软件供应商或者渠道伙伴提交验证表单，重新授权。
-   部分软件采用绑定网卡MAC地址注册合法环境。由于迁移专有网络VPC后，只保留一个网卡MAC地址，绑定的网卡MAC地址可能被删除。此时，您可以联系软件供应商，确认所使用的软件是否通过绑定网卡MAC地址注册您的实例，重新绑定到实例主网卡。更多详情，请参见[弹性网卡](/cn.zh-CN/网络/弹性网卡/弹性网卡概述.md)。

**Q：迁移前能使用FTP服务，迁移后服务不可用**

迁移后公网网卡被删除，FTP服务不可用。您可以：

1.  [转换实例公网IP为弹性公网IP（EIP）](/cn.zh-CN/网络/修改IPv4地址/专有网络类型ECS公网IP转为弹性公网IP.md)。
2.  [设置EIP为网卡可见](/cn.zh-CN/用户指南/绑定云资源/绑定辅助弹性网卡/设置EIP网卡可见模式.md)。

**说明：** 部分[已停售的实例规格](https://help.aliyun.com/document_detail/55263.html)和[上一代入门级实例规格](/cn.zh-CN/实例/实例规格族.md)由于不支持弹性网卡，可以[升级配置](/cn.zh-CN/实例/升降配实例/升降配方式概述.md)为具有兼容性的实例规格后采用以上方案。

**Q：部分Windows实例迁移后，实例内部找不到数据盘**

迁移后，部分Windows实例的云盘处于脱机状态，您可以通过以下方式批量设置云盘自动联机。更多信息，请参见[Windows系统的ECS实例磁盘脱机处理方法](https://help.aliyun.com/document_detail/197813.html)。

1.  在[ECS管理控制台](https://ecs.console.aliyun.com)的左侧导航栏，选择**运维与监控** \> **发送命令/文件（云助手）**。
2.  单击**创建/执行命令**，创建并执行以下云助手命令。具体操作，请参见[立即执行命令](/cn.zh-CN/运维与监控/云助手/使用云助手/立即执行命令.md)。

    云助手命令设置如下参数，其他参数可用默认值。

    |参数|取值|
    |--|--|
    |**命令类型**|PowerShell|
    |**命令内容**|    ```
@("san policy=onlineall") |diskpart
    ``` |
    |**选择实例**|选中需要修复的一个或多个Windows实例。|

3.  单击**执行并保存**。

## 相关文档

-   [云服务器ECS升级专有网络注意事项]()
-   [云数据库Redis切换为专有网络](/cn.zh-CN/用户指南/管理实例/管理网络连接/切换为专有网络VPC.md)
-   [云数据库RDS切换为专有网络](/cn.zh-CN/RDS MySQL 数据库/数据库连接/切换网络类型.md)
-   [云数据库RDS临时混访方案（同时保留经典网络和专有网络地址）](/cn.zh-CN/RDS MySQL 数据库/数据库连接/临时混访方案（同时保留经典网络和专有网络地址）.md)

