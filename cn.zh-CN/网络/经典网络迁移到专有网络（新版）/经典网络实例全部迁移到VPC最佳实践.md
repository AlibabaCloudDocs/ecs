# 经典网络实例全部迁移到VPC最佳实践

本文介绍如何将经典网络中的ECS实例和RDS实例全部迁移到VPC，并且在迁移完成后业务环境快速可用。

您在经典网络中，已购买ECS实例（ECS\_A和ECS\_B）和RDS实例，其中ECS实例作为应用服务器，RDS实例作为数据库服务器，各实例之间通过内网连接。由于业务发展需要，需要将ECS实例和RDS实例全部迁移到VPC。为了保持业务稳定，希望不改变实例的内网IP地址。应用场景如下图所示。

![架构图](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3440512161/p236788.png)

## 准备工作

在迁移前，建议完成如下操作：

-   为ECS实例创建快照，备份数据。具体操作，请参见[创建一个云盘快照](/cn.zh-CN/快照/使用快照/创建一个云盘快照.md)。
-   迁移时会重启ECS实例，建议您将应用服务设置为开机自启动，并做好可用性监控。

更多信息，请参见[迁移影响](/cn.zh-CN/网络/经典网络迁移到专有网络（新版）/ECS实例从经典网络迁移到专有网络.md)和[迁移准备工作](/cn.zh-CN/网络/经典网络迁移到专有网络（新版）/ECS实例从经典网络迁移到专有网络.md)。

## 步骤一：迁移ECS实例

通过实例迁移计划，将应用服务器（ECS\_A和ECS\_B）迁移到VPC网络，具体操作如下所示。

1.  登录[ECS管理控制台](https://ecs.console.aliyun.com)。

2.  在左侧导航栏，单击**运维与监控** \> **实例迁移计划**。

3.  在顶部菜单栏左上角处，选择地域。

4.  单击**创建迁移计划**。

5.  在**配置迁移计划**引导页，配置目标网络等信息，单击**下一步**。

    1.  选择迁移的目标可用区与专有网络。

        ![设置可用区](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5958091161/p235805.png)

        |配置项|说明|
        |---|--|
        |**请输入计划名称**|设置迁移计划名称，例如ECS\_c2v\_demo。|
        |**选择目标可用区**|从下拉列表中选择需要迁移的目标可用区，例如迁移到**深圳 可用区B**。**说明：**

        -   可用区选项是系统根据资源自动规划，您只能在下拉列表中选择对应可用区。
        -   一个实例迁移计划只能设置一个可用区，如果您需要设置多个可用区，需要创建多个迁移计划。 |
        |**选择迁移的目标专有网络**|从下拉列表中选择**（默认）系统自动创建专有网络，网段：10.0.0.0/8**，系统自动创建目标专有网络。|

    2.  设置安全组和MAC地址。

        ![网络属性](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4023728061/p203058.png)

        |配置项|说明|
        |---|--|
        |**目标安全组**|系统自动选择**（默认）克隆经典实例安全组****说明：** 不支持克隆存在组组授权规则的安全组。 |
        |**优先保留Mac地址策略**|选择需要保留的MAC地址，可选**私网Mac**或**公网Mac**。原业务环境中未绑定MAC地址，此处选择**私网Mac**。 |

    3.  设置保留实例的内网IP。

        ![内网ip](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5958091161/p235808.png)

        |配置项|说明|
        |---|--|
        |**保留实例内网IP**|系统默认选择**是**，保留ECS实例原来的内网IP地址。**创建虚拟交换机策略**默认选择**自动**，系统自动创建虚拟交换机。 |
        |**已迁移实例和该计划内还未迁移的经典实例保持内网联通**|所有ECS实例全部迁移到VPC，所以不需要和原经典网络保持互通，此处选择**否**。|

6.  在**选择待迁移实例**引导页，选中待迁移的ECS实例，单击**下一步**。

    ![选择迁移实例](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6874191161/p236696.png)

7.  在**预约迁移**引导页，为实例设置统一的迁移时间，单击**创建验证**。

    **说明：** 在迁移时需要重启ECS实例，建议您设置业务低谷的时间段进行迁移。

    ![设置迁移时间](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6874191161/p236697.png)

    1.  单击**设置统一迁移时间**。

    2.  在**设置统一迁移时间**对话框中，选择迁移时间。

    3.  单击**确定**。

8.  在**创建验证**对话框中，您可以查看迁移注意事项，并单击**确认并创建**。

    **说明：** 如果您的迁移计划不符合要求，系统将提示错误信息。此时您可以根据错误信息修改问题后重新创建迁移计划。

    迁移计划创建完成后，系统将在指定时间自动为您迁移ECS实例。正常迁移完成后，如下图所示。如果迁移过程中出现问题，请参见[常见问题](/cn.zh-CN/网络/经典网络迁移到专有网络（新版）/ECS实例从经典网络迁移到专有网络.md)。

    ![完成迁移计划](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6874191161/p236778.png)

    迁移完成后，您可以在左侧导航栏选择**实例与镜像** \> **实例**查看ECS。此时，ECS实例的网络类型已经变为VPC，内网IP地址保持不变。

    ![实例迁移后](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7035191161/p236779.png)


## 步骤二：迁移RDS实例

通过RDS切换网络类型功能，将数据库服务器（RDS实例）迁移到VPC网络，具体操作如下所示。更多信息，请参见[切换网络类型](/cn.zh-CN/RDS MySQL 数据库/数据库连接/切换网络类型.md)。

1.  获取系统自动创建的VPC信息。

    1.  选择**实例与镜像** \> **实例**。

    2.  单击已迁移到VPC的实例ID。

    3.  在实例详情页，单击专有网络ID和虚拟交换机ID，获取专有网络ID、虚拟交换机ID和虚拟交换机的可用区信息。

        ![网络信息](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3717412161/p237098.png)

        |名称|示例|
        |--|--|
        |专有网络ID|vpc-wz9avqy2c3fw8w4\*\*\*\*\*\*|
        |虚拟交换机|vsw-wz98loggfq88msu\*\*\*\*\*\*|
        |虚拟交换机可用区信息|深圳 可用区B|

2.  获取经典网络RDS的网络信息。

    1.  登录[RDS管理控制台](https://rds.console.aliyun.com/)。

    2.  在左侧导航栏单击**实例列表**。

    3.  在顶部菜单栏左上角处，选择地域。

    4.  单击目标RDS实例ID。

    5.  查看RDS实例的地域及可用区信息。

        ![rds地域及可用区](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3717412161/p237114.png)

        -   如果可用区和上一步骤中虚拟交换机的可用区一致，则执行下一步。
        -   如果可用区和上一步骤中虚拟交换机的可用区不一致，则需要先创建同一可用区的虚拟交换机，再执行下一步。关于如何创建虚拟交换机，请参见[创建交换机](/cn.zh-CN/专有网络和交换机/创建交换机.md)。
        **说明：** 本示例中，虚拟交换机和RDS都在华南1（深圳）可用区B，无需新建虚拟交换机。

3.  在左侧导航栏单击**数据库连接**。

4.  单击**切换专有网络**。

5.  在弹出的对话框中，选择VPC和交换机，以及是否保留经典网络地址。

    ![rds切换vpc](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3688412161/p237128.png)

    |配置项|说明|
    |---|--|
    |选择VPC|选择步骤1中查询的VPC ID（例如vpc-wz9avqy2c3fw8w4\*\*\*\*\*\*）。|
    |选择虚拟交换机|选择同可用区的虚拟交换机ID（例如vsw-wz98loggfq88msu\*\*\*\*\*\*）。**说明：** 如果是新建的虚拟交换机，请选择新的虚拟交换机ID。 |

6.  单击**确定**。

    迁移完成后，您可以在左侧导航栏单击**数据库连接**。此时，RDS的网络类型已经变成专有网络，内网连接串地址保持不变。

    ![rds结果](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5301512161/p237184.png)


## 步骤三：检查迁移结果

完成网络迁移后，通过访问业务系统，检查业务系统是否正常运行。

1.  通过浏览器访问Web应用。

2.  查看Web应用是否能够正常访问。

    ![业务系统](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3688412161/p237163.png)

    如上图所示，ECS实例和RDS实例都迁移到VPC后，无需修改配置文件，业务系统即能够正常运行。


